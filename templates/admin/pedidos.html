{% extends "admin/base.html" %}

{% block title %}Pedidos{% endblock %}
{% block page_title %}üìù Gesti√≥n de Pedidos{% endblock %}

{% block content %}
<div class="stats-bar">
  <div class="stat-card">
    <div class="stat-value">{{ pedidos|length }}</div>
    <div class="stat-label">Total Pedidos</div>
  </div>
  <div class="stat-card">
    <div class="stat-value">{{ pedidos|selectattr('estado', 'equalto', 'pendiente')|list|length }}</div>
    <div class="stat-label">Pendientes</div>
  </div>
  <div class="stat-card">
    <div class="stat-value">${{ "{:,.0f}".format(pedidos|sum(attribute='total')) if pedidos else 0 }}</div>
    <div class="stat-label">Total Facturado</div>
  </div>
</div>

{% if pedidos|length > 0 %}
<div style="margin-bottom: 20px; text-align: right;">
  <button onclick="limpiarPedidos()" class="btn btn-danger" style="background: #dc3545;">
    üóëÔ∏è Limpiar todos los pedidos
  </button>
</div>
{% endif %}

<div class="table-container">
  <table class="data-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Fecha</th>
        <th>Cliente</th>
        <th>Tel√©fono</th>
        <th>Email</th>
        <th>Entrega</th>
        <th>Total</th>
        <th>Estado</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for pedido in pedidos %}
      <tr>
        <td>{{ pedido.id }}</td>
        <td>{{ pedido.fecha[:16] if pedido.fecha else '' }}</td>
        <td><strong>{{ pedido.cliente_nombre }}</strong></td>
        <td>{{ pedido.cliente_telefono }}</td>
        <td>{{ pedido.cliente_email }}</td>
        <td>
          <span class="badge badge-info">
            {{ pedido.metodo_entrega|replace('retiro', 'Retiro')|replace('envio', 'Env√≠o') }}
          </span>
        </td>
        <td class="price">${{ "{:,.0f}".format(pedido.total) }}</td>
        <td>
          <span class="badge {% if pedido.estado == 'pendiente' %}badge-warning{% elif pedido.estado == 'completado' %}badge-success{% else %}badge-secondary{% endif %}">
            {{ pedido.estado|capitalize }}
          </span>
        </td>
        <td class="actions">
          <button onclick='verDetallePedido({{ pedido.id }}, {{ pedido|tojson|safe }})' class="btn btn-sm btn-info" title="Ver detalle">
            üëÅÔ∏è
          </button>
          <button onclick="cambiarEstado({{ pedido.id }}, '{{ pedido.estado }}')" class="btn btn-sm btn-success" title="Cambiar estado">
            ‚úì
          </button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% if pedidos|length == 0 %}
<div class="empty-state">
  <div class="empty-icon">üìù</div>
  <h3>No hay pedidos</h3>
  <p>Los pedidos realizados aparecer√°n aqu√≠</p>
</div>
{% endif %}

<!-- Modal detalle pedido -->
<div id="modalDetallePedido" class="modal" style="display:none">
  <div class="modal-content">
    <div class="modal-header">
      <h2>üìã Detalle del Pedido</h2>
      <span class="modal-close" onclick="document.getElementById('modalDetallePedido').style.display='none'">&times;</span>
    </div>
    <div class="modal-body">
      <div id="detallePedidoContenido"></div>
    </div>
  </div>
</div>

<script>
function verDetallePedido(id, pedido) {
  try {
    console.log('Detalle del pedido:', pedido);
    const productos = JSON.parse(pedido.productos);
    let html = '<div class="pedido-detalle">';
    
    // Informaci√≥n del cliente
    html += '<h3>Datos del Cliente:</h3>';
    html += '<div style="margin-bottom: 20px;">';
    html += `<p><strong>Nombre:</strong> ${pedido.cliente_nombre || 'N/A'}</p>`;
    if (pedido.cliente_cuit) html += `<p><strong>CUIT:</strong> ${pedido.cliente_cuit}</p>`;
    html += `<p><strong>Tel√©fono:</strong> ${pedido.cliente_telefono || 'N/A'}</p>`;
    html += `<p><strong>Email:</strong> ${pedido.cliente_email || 'N/A'}</p>`;
    html += '</div>';
    
    // Informaci√≥n de env√≠o si corresponde
    if (pedido.metodo_entrega === 'envio' && pedido.envio_direccion) {
      html += '<h3>Datos de Env√≠o:</h3>';
      html += '<div style="margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px;">';
      html += `<p><strong>Destinatario:</strong> ${pedido.envio_nombre_destinatario || pedido.cliente_nombre}</p>`;
      html += `<p><strong>Direcci√≥n:</strong> ${pedido.envio_direccion}</p>`;
      html += `<p><strong>Localidad:</strong> ${pedido.envio_localidad}</p>`;
      html += `<p><strong>Provincia:</strong> ${pedido.envio_provincia}</p>`;
      html += `<p><strong>C√≥digo Postal:</strong> ${pedido.envio_cp}</p>`;
      if (pedido.envio_referencias) html += `<p><strong>Referencias:</strong> ${pedido.envio_referencias}</p>`;
      html += '</div>';
    }
    
    // Productos
    html += '<h3>Productos:</h3>';
    html += '<table class="detalle-table">';
    html += '<thead><tr><th>Producto</th><th>Cant.</th><th>Precio</th><th>Subtotal</th></tr></thead>';
    html += '<tbody>';
    
    productos.forEach(p => {
      const subtotal = p.precio * p.cantidad;
      html += `<tr>
        <td><strong>${p.titulo}</strong><br><small>${p.codigo}</small></td>
        <td>${p.cantidad}</td>
        <td>$${p.precio.toLocaleString('es-AR')}</td>
        <td>$${subtotal.toLocaleString('es-AR')}</td>
      </tr>`;
    });
    
    html += '</tbody></table></div>';
    
    document.getElementById('detallePedidoContenido').innerHTML = html;
    document.getElementById('modalDetallePedido').style.display = 'block';
  } catch (e) {
    console.error('Error al mostrar detalle:', e);
    alert('Error al mostrar detalle: ' + e.message);
  }
}

function cambiarEstado(id, estadoActual) {
  const estados = ['pendiente', 'procesando', 'completado', 'cancelado'];
  const estadoActualIndex = estados.indexOf(estadoActual);
  const nuevoEstado = estados[(estadoActualIndex + 1) % estados.length];
  
  if (confirm(`¬øCambiar estado a "${nuevoEstado}"?`)) {
    fetch(`/admin/pedido/${id}/estado`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ estado: nuevoEstado })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert('Error al cambiar estado');
      }
    })
    .catch(error => {
      alert('Error: ' + error.message);
    });
  }
}

function limpiarPedidos() {
  if (confirm('‚ö†Ô∏è ¬øEst√°s seguro de que deseas eliminar TODOS los pedidos? Esta acci√≥n no se puede deshacer.')) {
    fetch('/admin/pedidos/limpiar', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert(`‚úÖ ${data.cantidad} pedido(s) eliminado(s)`);
        location.reload();
      } else {
        alert('‚ùå Error al limpiar pedidos: ' + data.error);
      }
    })
    .catch(error => {
      alert('‚ùå Error: ' + error.message);
    });
  }
}
</script>

<style>
.stats-bar {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.stat-card {
  background: white;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  text-align: center;
}

.stat-value {
  font-size: 2rem;
  font-weight: bold;
  color: var(--primary);
  margin-bottom: 5px;
}

.stat-label {
  color: var(--secondary);
  font-size: 0.9rem;
}

.badge-warning {
  background: #fff3cd;
  color: #856404;
}

.badge-secondary {
  background: #e2e3e5;
  color: #383d41;
}

.pedido-detalle {
  max-height: 400px;
  overflow-y: auto;
}

.detalle-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
}

.detalle-table th,
.detalle-table td {
  padding: 10px;
  text-align: left;
  border-bottom: 1px solid #ddd;
}

.detalle-table th {
  background: var(--light);
  font-weight: 600;
}
</style>
{% endblock %}
